<!-- Loader y Error -->
<div *ngIf="loading()" class="flex flex-col justify-center items-center h-full">
  <span class="loader my-3"></span>
  <p class="text-white/70">Cargando juego...</p>
</div>
<div *ngIf="error()" class="flex flex-col justify-center items-center h-full">
  <p class="text-red-500">{{ error() }}</p>
</div>

<!-- GAME CONTAINER -->
<div *ngIf="game() as g" class="fade-in">
  <div class="relative mx-auto my-6 w-full max-w-4xl rounded-[2.5rem] px-7 py-10
              border border-white/10 bg-white/5 backdrop-blur-xl
              shadow-[0_0_64px_10px_rgba(255,255,255,0.08)] flex flex-col items-center
              ring-2 ring-white/10">

    <h1 class="text-4xl font-extrabold text-white drop-shadow-xl mb-8 text-center tracking-wider select-none"
        style="text-shadow: 0 2px 16px #fff, 0 0 24px #fff8;">
      {{ g.room.name }} <span class="font-thin text-2xl">– Simon Dice</span>
    </h1>

    <!-- Turno y mensaje principal -->
    <p class="text-xl text-center font-semibold mb-4 text-white/95 shadow drop-shadow animate-bounce">
      {{ getTurnMessage() }}
    </p>

    <!-- Último color jugado, siempre visible excepto primer turno -->
    <div *ngIf="getLastSequenceColor() as lastCol" class="mb-12 flex flex-col items-center fade-in">
      <span class="text-sm text-white/70 mb-1 tracking-wide">Último color de la secuencia:</span>
      <span class="w-20 h-20 rounded-full border-4 border-white/30 shadow-[0_0_40px_8px_rgba(255,255,255,0.14)] mb-1 transition"
            [style.background]="lastCol.hex"></span>
      <span class="text-xs text-white/60 tracking-widest font-mono">({{lastCol.x}}, {{lastCol.y}})</span>
    </div>

    <!-- Tableros -->
    <div class="flex flex-col md:flex-row gap-12 md:gap-24 w-full justify-center mb-8">
      <!-- HOST -->
      <div class="flex flex-col items-center gap-3">
        <span class="text-white/70 text-xs">Anfitrión</span>
        <span class="font-bold text-lg tracking-wider mb-2 text-white/90">{{ g.room.hostPlayerName }}<span *ngIf="isHost()"> (tú)</span></span>
        <div
          class="grid gap-3 p-2 rounded-3xl border border-white/10 bg-white/10 shadow-lg"
          [ngStyle]="{
            'grid-template-columns': 'repeat(' + cols() + ', 3.5rem)',
            'grid-template-rows':    'repeat(' + rows() + ', 3.5rem)'
          }"
        >
          @for (cell of g.room.colorsConfig; track cell.x + '-' + cell.y) {
            <button
              class="rounded-2xl border-2 border-white/20 bg-white/20 shadow-[0_0_18px_4px_#fff4]
                     cursor-pointer hover:scale-110 active:scale-95 focus:outline-none transition-all
                     duration-200 outline-none"
              [style.background]="cell.hex"
              [class.opacity-60]="!canInteract('host')"
              [class.pointer-events-none]="!canInteract('host')"
              (click)="phase() === 'agregarColor' && isHost() ? addColor(cell) : (phase() === 'repetir' && isHost() ? selectInputColor(cell) : null)"
              title="Seleccionar color"
              style="width: 3.5rem; height: 3.5rem;"
            ></button>
          }
        </div>
        <!-- Secuencia y controles SOLO si es mi turno y soy host y estoy repitiendo secuencia -->
        <div *ngIf="isHost() && phase() === 'repetir'" class="mt-3 flex flex-col items-center w-full">
          <div class="flex gap-1 mb-2 max-w-xs md:max-w-md overflow-x-auto p-1 rounded bg-white/10 backdrop-blur"
               style="white-space: nowrap;">
            <span *ngFor="let c of inputSequence()">
              <span class="inline-block w-5 h-5 rounded border border-white/20" [style.background]="c.hex"></span>
            </span>
          </div>
          <div class="flex gap-2">
            <button class="px-6 py-1 bg-white/90 text-black font-bold rounded-xl shadow-lg border border-white/20
                           hover:bg-white focus:bg-white transition"
                    (click)="sendSequence()" [disabled]="!canSendSequence()">Enviar</button>
            <button class="px-3 py-1 bg-black/70 text-white rounded-xl shadow-sm border border-white/10
                           hover:bg-black/90 transition"
                    (click)="clearSequence()">Limpiar</button>
          </div>
        </div>
      </div>

      <!-- JUGADOR 2 -->
      <div class="flex flex-col items-center gap-3">
        <span class="text-white/70 text-xs">Jugador 2</span>
        <span class="font-bold text-lg tracking-wider mb-2 text-white/90">{{ g.room.secondPlayerName }}<span *ngIf="isSecond()"> (tú)</span></span>
        <div
          class="grid gap-3 p-2 rounded-3xl border border-white/10 bg-white/10 shadow-lg"
          [ngStyle]="{
            'grid-template-columns': 'repeat(' + cols() + ', 3.5rem)',
            'grid-template-rows':    'repeat(' + rows() + ', 3.5rem)'
          }"
        >
          @for (cell of g.room.colorsConfig; track cell.x + '-' + cell.y) {
            <button
              class="rounded-2xl border-2 border-white/20 bg-white/20 shadow-[0_0_18px_4px_#fff4]
                     cursor-pointer hover:scale-110 active:scale-95 focus:outline-none transition-all
                     duration-200 outline-none"
              [style.background]="cell.hex"
              [class.opacity-60]="!canInteract('second')"
              [class.pointer-events-none]="!canInteract('second')"
              (click)="phase() === 'agregarColor' && isSecond() ? addColor(cell) : (phase() === 'repetir' && isSecond() ? selectInputColor(cell) : null)"
              title="Seleccionar color"
              style="width: 3.5rem; height: 3.5rem;"
            ></button>
          }
        </div>
        <!-- Secuencia y controles SOLO si es mi turno y soy second y estoy repitiendo secuencia -->
        <div *ngIf="isSecond() && phase() === 'repetir'" class="mt-3 flex flex-col items-center w-full">
          <div class="flex gap-1 mb-2 max-w-xs md:max-w-md overflow-x-auto p-1 rounded bg-white/10 backdrop-blur"
               style="white-space: nowrap;">
            <span *ngFor="let c of inputSequence()">
              <span class="inline-block w-5 h-5 rounded border border-white/20" [style.background]="c.hex"></span>
            </span>
          </div>
          <div class="flex gap-2">
            <button class="px-6 py-1 bg-white/90 text-black font-bold rounded-xl shadow-lg border border-white/20
                           hover:bg-white focus:bg-white transition"
                    (click)="sendSequence()" [disabled]="!canSendSequence()">Enviar</button>
            <button class="px-3 py-1 bg-black/70 text-white rounded-xl shadow-sm border border-white/10
                           hover:bg-black/90 transition"
                    (click)="clearSequence()">Limpiar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error -->
    <p class="text-red-400 mt-4 text-center font-bold tracking-wider" *ngIf="sequenceError()">
      {{ sequenceError() }}
    </p>
  </div>
</div>

<!-- EXTRAS PARA EFECTOS (Opcional) -->
<style>
  .fade-in { animation: fadeIn 1s; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .loader { border: 4px solid #222; border-top: 4px solid #fff; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite;}
  @keyframes spin { 100% { transform: rotate(360deg); } }
</style>
